# CentAgent 后续改进方向（Future）

本文档用于在现有实现基础上，给出后续可持续迭代的改进方向清单。内容结合当前仓库落地情况与 `Design.md` / `Roadmap.md` 的目标设想，按“优先级 + 主题”组织，便于逐步推进。

## 1. 现状快照（用于对齐预期）

- 已形成可运行闭环：`centagent start`（监控采集/落库/分层清理）+ `centagent chat`（Agent→Tools→Docker/DB）+ 可选 `--ui=console|tui`。
- 文档与现实存在偏差：`Roadmap.md` 的 CLI/TUI/Integration 状态需要更新为 Done，并把真正未完成项迁移到 Pending。

## 2. P0：近期必须补齐（影响可用性/一致性）

### 2.1 CLI 的“单次指令模式”（Design 中的 Command Mode）

- 新增 `centagent analyze --container <name|id> [--range 1h|24h] [--since ...]`：
  - 输入：容器标识 + 时间范围/采样策略。
  - 输出：结构化报告（CPU/内存峰值、重启次数、错误日志摘要、建议动作）。
- 新增 `centagent query stats|logs ...` 作为“纯查询工具”，便于脚本化与调试。

### 2.2 人类决策层：从“允许/取消”升级为“多选决策 + 风险分级”

- 为工具调用引入风险等级（只对高危操作强制确认）：
  - 低风险：list/inspect/query。
  - 中风险：restart 单容器、prune 有限范围。
  - 高风险：remove、stop 关键容器、network/volume prune 等。
- 将确认从二选一扩展为多选动作（与 `Design.md` 示例对齐）：
  - 例如：检测容器异常后给出“重启 / 查看最近日志 / 查看历史 stats / 暂不处理”等选项。

### 2.3 上下文生成与 Token 成本控制（参考 `TokenOptimization.md`）

- Tool 输出降噪（优先级最高）：
  - 将工具输出全文从对话 history 中移除：全文外置存储（内存/文件/DB），history 仅保留短摘要 + 引用 ref。
  - 新增按需取回工具：`get_tool_output(ref, start?, end?, grep?, json_path?)`，让模型需要细节时自行拉取，而不是反复携带长文本。
  - 对长输出采用固定摘要策略：list 仅保留前 N 条关键信息；inspect 仅保留核心字段；logs 仅保留最后 N 行或仅保留“行数 + ref”。
- 按预算截断（兜底上限）：
  - 在“喂给模型”之前对 history 按预算裁剪（先做字符预算，后续再考虑 token 估算/精确 tokenizer）。
  - 优先删除低价值高体积内容（尤其是 Role=tool 的长输出），必要时再删除最早的对话轮次或用摘要替换早期内容。
  - 预算做成可配置项（CLI/config），给出默认值并提供诊断输出（例如：本轮 history 字符数、裁剪条数）。

## 3. P1：能力增强（提高“智能化”与“可解释性”）

### 3.1 “实时 Docker + 历史 DB”双通路诊断工具集

- 统一诊断工作流：
  - 实时：容器当前资源占用、最近事件、即时日志片段。
  - 历史：DB 中的 stats/logs 聚合、异常区间定位、趋势变化。
- 为常见诊断场景提供一键工具：
  - `summarize_container_health`：输出最近 15min/1h 的健康摘要与异常点。
  - `find_spike_windows`：定位 CPU/内存尖峰的时间窗口，联动查询同窗口日志。

### 3.2 RAG：基于 DB 的“可引用”问答（面向真实问答体验）

- 将“DB 查询工具”升级为“检索 + 证据引用 + 结论”：
  - 检索：按时间/容器/关键字抽取候选片段（logs）与异常区间（stats）。
  - 重排：基于相关性/新鲜度/严重度排序。
  - 汇总：回答必须带引用（时间戳、容器、日志片段/统计区间），便于追溯。
- 若后续引入向量检索：
  - 对日志片段做分块与向量化，按容器维度建立索引。
  - 保持“本地优先”：SQLite + 向量扩展或轻量本地库，避免引入重依赖。

### 3.3 审计与可追溯（从“记录”到“可查询/可回放”）

- 审计增强字段：是否确认、确认选项、失败原因、耗时、影响范围（容器/资源列表）。
- 新增 `centagent audit list|show|prune`：
  - list：分页查看最近 N 条。
  - show：展示一次对话/一次工具链路的完整执行轨迹。
  - prune：按条数/时间清理（避免 DB 膨胀）。

## 4. P2：稳定性与性能（面向长期运行）

### 4.1 监控与落库优化

- 采集侧：支持按容器标签/名称前缀过滤，避免采集无关容器。
- 落库侧：批量写入与退避策略统一，避免 SQLite Busy 抖动；Retention 清理按批次 + idle sleep。
- 索引与聚合：为常用查询维度建立索引，并提供预聚合视图（例如按 5min 桶聚合峰值/平均值）。

### 4.2 配置与可观测性

- 配置分层：命令行参数 > 环境变量 > 配置文件，允许“无配置启动”但有合理默认值。
- 日志体系：统一 log 格式、级别、采样；为 monitor/docker/storage/agent 打印关键 lifecycle（不包含敏感信息）。
- 健康诊断：`centagent doctor` 检查 Docker 连接、DB 可写、权限、配置完整性等。

## 5. P3：产品体验与扩展性

### 5.1 TUI 体验升级

- 更清晰的对话气泡与角色区分（User/Assistant/Tool）。
- 工具执行进度与可取消（长耗时操作：pull image、prune 等）。
- “会话存档/导出”：把一次对话的输入输出与关键证据导出为 Markdown。

### 5.2 插件化与工具扩展

- Tool 注册机制标准化：描述元数据（风险、需要确认、输入 schema、输出摘要模板）。
- 引入“策略层”：对同一目标提供多种处理策略（例如重启前先拉日志、先做健康检查等）。

## 6. P4：安全与合规（逐步推进）

- 凭证与 Token 管理：
  - 支持多模型配置与按命令选择模型。
  - 本地加密存储（可选）与脱敏输出。
  - Token/上下文窗口控制（摘要化旧消息、限制工具输出长度）。
- 权限最小化：对危险操作提供更强提示与可配置禁用名单（如禁止 remove/prune）。

## 7. 质量保障（贯穿所有阶段）

- 单测：对每个 Tool 的输入校验、失败路径、审计写入做覆盖。
- 集成测试：在可控 Docker 环境中验证 start/chat/analyze 闭环。
- 回归基线：提供一组“黄金用例”（容器异常、日志错误、网络问题）确保行为稳定。

## 8. 里程碑验收建议（避免“做了很多但不好验收”）

- M1：文档对齐 + analyze 命令可用 + 风险分级确认落地。
- M2：诊断工具集（实时+历史）可稳定产出“带证据”的报告。
- M3：审计可查询/可清理 + 长期运行稳定（Busy 可控、DB 体积可控）。
- M4：RAG 体验上线（引用证据、可追溯、可导出）。
